<template>
    <style>
        :host {
          border-width: 2px;
          display: inline-block;
          text-align: center;
        }
    </style>
    <slot></slot>
</template>
<script>
  (function(window, document, undefined) {
    var template = (
      document._currentScript || document.currentScript
    ).ownerDocument.querySelector('template').content;

    class GPIOButton extends HTMLElement {

      get pin() {
        return this.getAttribute('pin');
      }

      constructor() {
        super();

        // if this.value is set, ping API to set initial value
        var initialValue = this.getAttribute('value');
        if (initialValue) {
          this.setGPIOValue(initialValue);
        // else query current state via API and set value
        } else {
          this.fetchGPIOValue();
        }

        this.addEventListener('click', e => {
          this.toggleGPIOValue();
        });
      }

      connectedCallback() {
        var shadowRoot = this.attachShadow({ mode: 'open' });
        var clone = document.importNode(template, true);
        shadowRoot.appendChild(clone);
      }

      fetchGPIOValue() {
        if (! this.pin) return;

        fetch('/gpio/' + this.pin)
          .then(response => this._handleErrors(response))
          .then(body => this._updateAttributes(body))
          .catch(console.log);
      }

      setGPIOValue(value) {
        if (! this.pin) return;

        value = value.toString();
        if (value != "0") value = "1";

        var payload = { value: value };

        fetch('/gpio/' + this.pin, {
          method: 'PUT',
          headers: new Headers({
            'Content-Type': 'application/json'
          }),
          body: JSON.stringify(payload)
        }).then(response => this._handleErrors(response))
          .then(body => this._updateAttributes(body))
          .catch(console.log);
      }

      toggleGPIOValue() {
        this.setGPIOValue(this.getAttribute('value') == "0" ? "1" : "0");
      }

      _handleErrors(response) {
        if (! response.ok) throw response.statusText;
        return response.text();
      }

      _updateAttributes(body) {
        var pin = JSON.parse(body);
        this.setAttribute('value', pin.value)
      }
    }
    window.customElements.define('gpio-button', GPIOButton);
  })(window, document);
</script>
